name: Build, test and package

on: push

jobs:
  package:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-dotnet@v2
        with:
          dotnet-version: '6.0.x'
      - uses: actions/cache@v3.0.2
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      - name: Start MySQL for testing
        run: sudo systemctl start mysql.service
      - name: Test
        run: |
          dotnet test "./BadMedicine.Dicom.Tests/BadMedicine.Dicom.Tests.csproj" -nologo
          dotnet build -c Debug
          cd ./BadDicom/bin/Debug/net6.0
          curl https://raw.githubusercontent.com/HicServices/DicomTypeTranslation/master/Templates/CT.it > ./CT.it
          mv BadDicom.template.yaml BadDicom.yaml
          dotnet ./BadDicom.dll ./ 50000 10 CT
          sed -i "s/Batches: 1/Batches: 5/g" ./BadDicom.yaml
          sed -i "s/DropTables: false/DropTables: true/g" ./BadDicom.yaml
          dotnet ./BadDicom.dll ./ 50000 10 CT
          cd -
      - name: Package
        run: |
          mkdir -p dist
          dotnet pack ./BadMedicine.Dicom/BadMedicine.Dicom.csproj -c Release -p:IncludeSymbols=true -p:Version=$(grep AssemblyInformationalVersion SharedAssemblyInfo.cs | cut -d'"' -f2) -nologo
          for platform in linux win
          do
            dotnet publish -c Release -r $platform-x64 -o $platform-x64 --self-contained true -nologo -v q
          done
          zip -9r dist/baddicom-win-x64-v$(grep AssemblyInformationalVersion SharedAssemblyInfo.cs | cut -d'"' -f2).zip ./win-x64
          tar czf dist/baddicom-linux-x64-v$(grep AssemblyInformationalVersion SharedAssemblyInfo.cs | cut -d'"' -f2).tar.gz ./linux-x64
      - name: Nuget push
        if: contains(github.ref,'refs/tags/')
        run: |
          dotnet nuget push ./BadMedicine.Dicom/bin/Release/HIC.BadMedicine.Dicom.*.nupkg -k ${{ secrets.NUGET_KEY }} --skip-duplicate -s https://api.nuget.org/v3/index.json
      - name: Upload release binaries
        uses: svenstaro/upload-release-action@2.2.1
        if: contains(github.ref, 'refs/tags/v')
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/baddicom*
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true
